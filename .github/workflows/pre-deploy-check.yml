name: Pre-Deploy Health Check

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # manually run karne ke liye

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Verify Required Files
        run: |
          echo "ğŸ” Checking important files..."
          MISSING=0
          for f in requirements.txt .github/workflows/deploy.yml; do
            if [ ! -f "$f" ]; then
              echo "âŒ Missing: $f"
              MISSING=1
            else
              echo "âœ… Found: $f"
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "ğŸš¨ Required files missing. Fix before deploying."
            exit 1
          fi

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Check Python Syntax
        run: |
          echo "ğŸ§ª Running syntax checks..."
          python -m compileall . || (echo "âŒ Python syntax errors found!" && exit 1)
          echo "âœ… No syntax errors."

      - name: Run Linter (flake8)
        run: |
          pip install flake8
          echo "ğŸ” Running flake8 for code style and errors..."
          flake8 . || (echo "âš ï¸ Code issues detected (fix recommended)" && exit 0)

      - name: Check for Extra/Missing Files
        run: |
          echo "ğŸ“‚ Checking repo structure..."
          if [ ! -f Procfile ] && [ ! -f Dockerfile ]; then
            echo "âš ï¸ Neither Procfile nor Dockerfile found. Add one for deployment."
          else
            echo "âœ… Deployment entry file exists."
          fi

      - name: Run Tests (if available)
        run: |
          echo "ğŸ§ª Running tests..."
          if [ -d tests ]; then
            pytest || (echo "âŒ Some tests failed!" && exit 1)
          else
            echo "âš ï¸ No tests directory found. Skipping tests."
          fi
