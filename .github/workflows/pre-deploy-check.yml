name: Pre-Deploy Health Check

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # manually run karne ke liye

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Verify Required Files
        run: |
          echo "🔍 Checking important files..."
          MISSING=0
          for f in requirements.txt .github/workflows/deploy.yml; do
            if [ ! -f "$f" ]; then
              echo "❌ Missing: $f"
              MISSING=1
            else
              echo "✅ Found: $f"
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "🚨 Required files missing. Fix before deploying."
            exit 1
          fi

      - name: Install Dependencies
        run: |
          echo "📦 Installing dependencies..."
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Check Python Syntax
        run: |
          echo "🧪 Running syntax checks..."
          python -m compileall . || (echo "❌ Python syntax errors found!" && exit 1)
          echo "✅ No syntax errors."

      - name: Run Linter (flake8)
        run: |
          pip install flake8
          echo "🔍 Running flake8 for code style and errors..."
          flake8 . || (echo "⚠️ Code issues detected (fix recommended)" && exit 0)

      - name: Check for Extra/Missing Files
        run: |
          echo "📂 Checking repo structure..."
          if [ ! -f Procfile ] && [ ! -f Dockerfile ]; then
            echo "⚠️ Neither Procfile nor Dockerfile found. Add one for deployment."
          else
            echo "✅ Deployment entry file exists."
          fi

      - name: Run Tests (if available)
        run: |
          echo "🧪 Running tests..."
          if [ -d tests ]; then
            pytest || (echo "❌ Some tests failed!" && exit 1)
          else
            echo "⚠️ No tests directory found. Skipping tests."
          fi
